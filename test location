<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS å®šä½ç²¾ç¢ºåº¦æ¸¬è©¦</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* è‡ªå®šç¾©æŒ‰éˆ•æ¨£å¼ */
        .custom-control {
            background: #fff; border: none; border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            cursor: pointer; margin: 10px; padding: 12px 20px;
            font-size: 16px; font-weight: bold; color: #1a73e8;
            transition: background 0.2s;
        }
        .custom-control:hover { background: #f1f3f4; }
        .custom-control:active { background: #e8f0fe; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9yd5GeV-J0SHVtpkeHvtFfSryaavAKIE&callback=initMap&v=weekly" defer></script>

    <script>
        let map, infoWindow, accuracyCircle, userMarker;

        function initMap() {
            // åˆå§‹åŒ–åœ°åœ–ï¼Œé è¨­ä¸­å¿ƒé»ï¼ˆå°åŒ—ï¼‰
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 25.0339, lng: 121.5644 },
                zoom: 13,
                mapTypeControl: false,
                fullscreenControl: false,
                streetViewControl: false
            });

            infoWindow = new google.maps.InfoWindow();

            // å»ºç«‹å®šä½æŒ‰éˆ•
            const locationButton = document.createElement("button");
            locationButton.textContent = "ğŸ¯ åµæ¸¬æˆ‘çš„ç²¾ç¢ºä½ç½®";
            locationButton.classList.add("custom-control");
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);

            locationButton.addEventListener("click", () => {
                if (navigator.geolocation) {
                    // é¡¯ç¤ºè®€å–ä¸­ç‹€æ…‹
                    locationButton.textContent = "â³ å®šä½ä¸­...";
                    locationButton.disabled = true;

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };
                            const accuracy = position.coords.accuracy;

                            // 1. æ¸…é™¤èˆŠçš„æ¨™è¨˜èˆ‡åœ“åœˆ
                            if (accuracyCircle) accuracyCircle.setMap(null);
                            if (userMarker) userMarker.setMap(null);

                            // 2. ç¹ªè£½ç²¾ç¢ºåº¦åœ“åœˆ (Accuracy Circle)
                            accuracyCircle = new google.maps.Circle({
                                map: map,
                                center: pos,
                                radius: accuracy, // èª¤å·®åŠå¾‘ï¼ˆå…¬å°ºï¼‰
                                fillColor: "#4285F4",
                                fillOpacity: 0.15,
                                strokeColor: "#4285F4",
                                strokeOpacity: 0.5,
                                strokeWeight: 1,
                                clickable: false
                            });

                            // 3. æ”¾ç½®ä¸€å€‹è—è‰²å°é»æ¨™è¨˜
                            userMarker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: "#4285F4",
                                    fillOpacity: 1,
                                    strokeColor: "white",
                                    strokeWeight: 2,
                                }
                            });

                            // 4. æ›´æ–°åœ°åœ–è¦–è§’
                            map.setCenter(pos);
                            
                            // æ ¹æ“šèª¤å·®ç¨‹åº¦è‡ªå‹•èª¿æ•´ç¸®æ”¾ç´šåˆ¥
                            if (accuracy < 100) {
                                map.setZoom(18);
                            } else {
                                map.fitBounds(accuracyCircle.getBounds());
                            }

                            // é¡¯ç¤ºè³‡è¨Šè¦–çª—
                            infoWindow.setPosition(pos);
                            infoWindow.setContent(`
                                <div style="padding:5px;">
                                    <b>å®šä½çµæœ</b><br>
                                    èª¤å·®åŠå¾‘ï¼šç´„ ${Math.round(accuracy)} å…¬å°º<br>
                                    <small>æ™‚é–“ï¼š${new Date().toLocaleTimeString()}</small>
                                </div>
                            `);
                            infoWindow.open(map);

                            // æ¢å¾©æŒ‰éˆ•
                            locationButton.textContent = "ğŸ¯ åµæ¸¬æˆ‘çš„ç²¾ç¢ºä½ç½®";
                            locationButton.disabled = false;
                        },
                        (error) => {
                            handleLocationError(true, infoWindow, map.getCenter());
                            locationButton.textContent = "ğŸ¯ åµæ¸¬æˆ‘çš„ç²¾ç¢ºä½ç½®";
                            locationButton.disabled = false;
                        },
                        { 
                            enableHighAccuracy: true, // å¼·åˆ¶é–‹å•Ÿ GPS
                            timeout: 10000, 
                            maximumAge: 0 
                        }
                    );
                } else {
                    handleLocationError(false, infoWindow, map.getCenter());
                }
            });
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(
                browserHasGeolocation
                    ? "éŒ¯èª¤ï¼šå®šä½å¤±æ•—ï¼ˆè«‹ç¢ºèªå·²é–‹å•Ÿ GPS ä¸¦æˆæ¬Šç¶²é å­˜å–ä½ç½®ï¼‰ã€‚"
                    : "éŒ¯èª¤ï¼šæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚"
            );
            infoWindow.open(map);
        }

        window.initMap = initMap;
    </script>
</body>
</html>
